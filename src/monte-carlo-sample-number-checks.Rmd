---
title: "Monte Carlo Sample Calculations"
author: "Victor Tsang (z5209633)"
date: "`r Sys.Date()`"
output:
  html_notebook: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::knit_hooks$set(timeit = local({
  now = NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res = difftime(Sys.time(), now)
      now <<- NULL
      # use options$label if you want the chunk label as well
      paste('Time for this code chunk:', as.character(res))
    }
  }})
)
```

#### Setup

Source our helper functions and set our parameters.

```{r}
source("minmi-functions.R")

set.seed(2022)

n = 30                             # Number of fossil samples in each dataset
theta.true = 10000                 # True extinction date
K = 20000                          # Upper bound for fossil ages
 
dating_error.mean = 0              # True mean of radiocarbon dating error
dating_error.sd = 272              # True Standard deviation
 
alpha = 0.05                       # 95% confidence interval

```

First, simulate some data:

```{r}
W = runif(n=n, min=theta.true, max=K) + rnorm(n=n, mean=dating_error.mean, sd=dating_error.sd)
m=min(W)
```


## Asymptotic Variance Formula

```{r}
estimate_var.delta_method = function (q, B, u, K, m, eps.mean, eps.sigma) {
  # Initial estimate of theta_q using no measurement error case
  theta_q.hat.init = K - q^(-1/n)*(K-m) 
  
  # Monte carlo samples
  e = uniform_to_tnorm(u, eps.mean, eps.sigma, a=-Inf, b=m-theta_q.hat.init)
  
  # pdfs and CDF evaluations (for convenience)
  f_eps.K = dnorm(K-theta_q.hat.init, eps.mean, eps.sigma)
  F_eps.K = pnorm(K-theta_q.hat.init, eps.mean, eps.sigma)
  f_eps.m = dnorm(m-theta_q.hat.init, eps.mean, eps.sigma)
  F_eps.m = pnorm(m-theta_q.hat.init, eps.mean, eps.sigma)
  
  # Monte carlo estimates
  psi_hat = apply((m-e-theta_q.hat.init)/(K-e-theta_q.hat.init) * F_eps.m, 1, mean)
  psi_hat.prime = apply((m-K)/(K-e-theta_q.hat.init)^2 * F_eps.m, 1, mean)
  
  u_hat.prime = psi_hat * ( (F_eps.m * f_eps.K)/F_eps.K^2 - f_eps.m/F_eps.K) + F_eps.m/F_eps.K * psi_hat.prime

  var_estimate = (F_eps.m/F_eps.K)^2 * var(psi_hat) * (u_hat.prime)^(-2)
  
  return(var_estimate)
}
```

## Checks

### Sample Variance of $\hat\theta_q$

```{r}
n = 30

B = unique(round(pracma::logseq(2, 2000, 40)))
num.B = length(B)

num.estimates = 50

sample_var.theta_q = list()
sample_var.theta_q$lower = rep(NA, num.B)
sample_var.theta_q$upper = rep(NA, num.B)

expctd_var.theta_q = list()
expctd_var.theta_q$lower = rep(NA, num.B)
expctd_var.theta_q$upper = rep(NA, num.B)

u = matrix(runif(n*num.estimates*B[num.B], min=0, max=1), ncol=B[num.B])

uniroot.interval = c(5000, 19500)
```

```{r}
start_time = Sys.time()
for (i in 1:num.B) {
  # Get Sample Variances
  theta.hat.lower = rep(NA, num.estimates)
  theta.hat.upper = rep(NA, num.estimates)
  # Generate 100 estimates of \theta_q
  for (j in 1:num.estimates) {
    mc.samples = u[((j-1)*n+1):((j)*n), 1:(B[i])]
    theta.hat.lower[j] = estimate_quantile.minmi(q=0.025, K, W, mc.samples, 
                                                 dating_error.mean, 
                                                 dating_error.sd, uniroot.interval)
    theta.hat.upper[j] = estimate_quantile.minmi(q=0.975, K, W, mc.samples, 
                                                 dating_error.mean, 
                                                 dating_error.sd, uniroot.interval)
  }
  sample_var.theta_q$lower[i] = var(theta.hat.lower)
  sample_var.theta_q$upper[i] = var(theta.hat.upper)
  
  # Get E(delta method estimate of variance)
  expctd_var.theta_q$upper[i] = mean(estimate_var.delta_method(q=0.025, B[i], u[, 1:B[i]],
                                                       K, m, dating_error.mean, dating_error.sd))
  expctd_var.theta_q$lower[i] = mean(estimate_var.delta_method(q=0.975, B[i], u[, 1:B[i]], 
                                                       K, m, dating_error.mean, dating_error.sd))
}
print(Sys.time() - start_time)

res.df = data.frame(
  B = B,
  sample_var.upper = sample_var.theta_q$upper,
  sample_var.lower = sample_var.theta_q$lower,
  expctd_var.upper = expctd_var.theta_q$upper,
  expctd_var.lower = expctd_var.theta_q$lower
)

head(res.df)
```

```{r fig.width=12, fig.height=5}
options(scipen=9)

par(mfrow=c(1,2))

plot(B, sample_var.theta_q$lower, log="xy",
     type="b", main="Sample Var vs. E(Delta method var) | q=0.025", col="blue",
     ylim=c(min(sample_var.theta_q$lower, expctd_var.theta_q$lower), max(sample_var.theta_q$lower, expctd_var.theta_q$lower)), ylab=NA)
lines(B, expctd_var.theta_q$lower, type="b", main="Expected Var",  col="red")
legend("topright",
       legend=c("E(Delta Method Var)", "Sample Var"),
       lty=c(1,1),
       pch=c(1,1),
       col=c("red", "blue"))

plot(B, sample_var.theta_q$upper, log="xy",
     type="b", main="Sample Var vs. E(Delta method var) | q=0.975", col="blue",
     ylim=c(min(sample_var.theta_q$upper, expctd_var.theta_q$upper), max(sample_var.theta_q$upper, expctd_var.theta_q$upper)), ylab=NA)
lines(B, expctd_var.theta_q$upper, type="b", main="Expected Var",  col="red")
legend("topright",
       legend=c("E(Delta Method Var)", "Sample Var"),
       lty=c(1,1),
       pch=c(1,1),
       col=c("red", "blue"))
```


