---
title: "Estimating Monte Carlo Confidence Intervals for Fossil Data using Garthwaite 1992"
author: "Victor Tsang"
date: "08/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Assumptions

* Uniform Fossil Recovery: fossil ages are uniformly distributed

### Set parameters

```{r}
set.seed(22)
alpha = 0.05
b = 18000 # upper bound for dates we can get fossils in
```

### Import data

```{r}
library(readxl)
# Import mammoth data from fossildata.xlsx
fossil_dataframe = read_excel(
  path='fossildata.xlsx', 
  sheet="MammothPrimEBer", 
  range="M3:N36", 
  col_names=c("age", "sd"), 
  col_types=c('numeric', 'numeric')
)
fossil_dataframe = fossil_dataframe[fossil_dataframe$age<b,] # suggest not forcing ages to be integers

n_fossils = length(fossil_dataframe$age)
```

### Get point estimate of extinction date

This is just the MLE (the age of the last recorded fossil)

```{r}
obs_stat = min(fossil_dataframe$age)
obs_stat_ub = obs_stat-(b-obs_stat)/(n_fossils+1) #bias-corrected MLE for lower bound
```


### Calculate step length proportionality constant $k's$

We will set $k = 2/\{ z_\alpha (t\pi)^{-1/2}\exp{(-z_\alpha^2/2)}$ where $z_\alpha$ is the upper 100 $\alpha$ % point of the standard normal distribution.

```{r}
k = 2 / (qnorm(1-alpha) * (2*pi)^(-0.5) * exp(- (qnorm(1-alpha)^2)/2))
```


### Select stopping criteria

Some dodgy stuff going on here

```{r}
max_iter = 1600
```


### Select starting values

Generate $(2 - \alpha) / \alpha$ resamples:

```{r}
n_init_resamples = ceiling((2-alpha)/alpha)
resamples = runif(n=n_init_resamples*n_fossils, min=obs_stat_ub, max=b)
init_fossils = matrix(resamples, ncol=n_init_resamples)
init_resamples = apply(init_fossils,2,min)
init_resamples_sorted = sort(init_resamples)
init_resamples_sorted
```

We start at the $m$th iteration and set the values to the second largest and second smallest resample:

```{r}
m = ceiling(min(50, 0.3*n_init_resamples))

bound_upper = rep(NA,max_iter)
bound_lower = rep(NA,max_iter)

bound_upper[m] = min(init_resamples_sorted[n_init_resamples-1], obs_stat) #TODO
bound_lower[m] = init_resamples_sorted[2]

bound_upper[m]
bound_lower[m]
```

### RM Process for both upper and lower CI bounds

```{r}
rm_process = function (bound_vec, obs_stat_ub, n, alpha, b, m, max_iter, k) {
  for (i in m:max_iter) {
    # Generate resamples
    resamples = runif(n=n, min=bound_vec[i], max=b)
    
    # calculate step length
    c = max(2*k*abs(bound_vec[m] - obs_stat_ub), 1000) # TODO
    
    # Update upper bound
    if (min(resamples) <= obs_stat_ub) {
      bound_vec[i+1] = (bound_vec[i] + c*(1-alpha)/ i)
    } 
    else {
      bound_vec[i+1] = (bound_vec[i] - c*alpha / i)
    }
  }
  return(bound_vec[m:max_iter])
}

```

```{r}
res_upper = rm_process(
  bound_vec = bound_upper,
  obs_stat_ub = obs_stat_ub,
  n = n_fossils,
  alpha = alpha,
  b = b,
  m = m,
  max_iter = max_iter,
  k = k
)

res_lower = rm_process(
  bound_vec = bound_lower,
  obs_stat_ub = obs_stat_ub,
  n = n_fossils,
  alpha = (1-alpha),
  b = b,
  m = m,
  max_iter = max_iter,
  k = k
)

res_upper[length(res_upper)]
res_lower[length(res_lower)]
```

### Plot iterations

```{r}
plot(res_upper,
     pch=4,
     type="l",
     xlab="i",
     col='red',
     ylab=NA,
     main="CI Convergence",
     ylim=c(min(res_lower), max(res_upper)))
lines(res_lower, pch=4, col='blue')
abline(h=obs_stat_ub, col="black")

legend("topright", legend=c("U_i", "L_i", "obs_stat_ub"), col=c("red", "blue", "black"), lty=c(1,1,1))
```
