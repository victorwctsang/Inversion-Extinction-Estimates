---
title: "SI-RM Scrapbook"
author: "Victor Tsang (z5209633)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
```

```{r}
load("../data/synthetic-data.RData")

attach(synthetic.data.config)
set.seed(3)

alpha = 0.05

datasets.err1 = datasets %>% filter(error_factor == 1)
datasets.err1_sample = datasets.err1#datasets.err1[sample(1:nrow(datasets.err1), 100, ), ]
head(datasets.err1_sample)
```

## Stopping Criteria behaviour

```{r}
source("../src/simulated-inversion.R")
source("../src/garthwaite-robbins-munro-functions.R")

theta.test_vec = seq(4000, 14000) # true theta is 10,000

SI_RM.iters = data.frame(
  Dataset_id = integer(),
  Error_Factor = integer(),
  Iteration = integer(),
  Endpoint = factor(),
  Estimate = numeric()
)

sd = fossil.sd
for (i in 1:nrow(datasets.err1_sample)) {
  iter = datasets.err1_sample[i,]
  W = as.numeric(iter$W[[1]])
  
  # Use Simulated Inversion to estimate the quantile function
  SI_results = simulated_inversion(alpha, W, sd, K, theta.test_vec,
                                   dating_error.mean=0, return_model = T)
  
  # Apply SI_RM
  SI_RM = estimate_CI.rm(W=W, K=K, alpha=alpha, max_iter=1000,
                         eps.mean=dating_error.mean, eps.sigma=mean(sd),
                         .CI_estimates = SI_results, .model=SI_results$model, 
                         return_iters = T)
  lower_iters = data.frame(Dataset_id = i,
                           Error_Factor = iter$error_factor,
                           Iteration=1:length(SI_RM$lower.iters),
                           Endpoint="lower",
                           Estimate=SI_RM$lower.iters)
  upper_iters = data.frame(Dataset_id = i,
                           Error_Factor = iter$error_factor,
                           Iteration=1:length(SI_RM$upper.iters),
                           Endpoint="upper",
                           Estimate=SI_RM$upper.iters)
  
  # Append to our results df
  SI_RM.iters = rbind(SI_RM.iters, lower_iters, upper_iters)
}
```

```
# SI_RM.iters %>%
#   mutate(Endpoint = ifelse(Endpoint == "lower", "q=0.025", "q=0.975")) %>%
#   ggplot(mapping=aes(x=Iteration, y=Estimate, group=Dataset_id, colour=Endpoint)) +
#   geom_line(alpha=0.5) +
#   facet_wrap(Endpoint ~ ., scales="free_x") +
#   theme_bw() +
#   guides(colour="none")
```

```{r}
SI_RM.iters %>%
  group_by(Dataset_id, Endpoint) %>%
  summarise(Iters = max(Iteration)) %>%
  mutate(Endpoint = ifelse(Endpoint == "lower", "q=0.025", "q=0.975")) %>%
  ggplot(mapping=aes(x=Iters)) +
  geom_histogram() +
  facet_wrap(Endpoint ~ ., scales="free_x") +
  ggtitle("Distribution of Number of Iterations used")
```

```{r}
tmp = SI_RM.iters %>%
  group_by(Dataset_id, Endpoint) %>%
  summarise(Iters = max(Iteration))
```
```{r}
for (level in unique(tmp$Endpoint)) {
  print(summary(tmp[tmp$Endpoint == level, ]))
}
```



## Performance with "bad" estimates and fixed number of iterations

```{r}
tmp.data = datasets.err1_sample[1, ]
tmp.W = as.numeric(tmp.data$W[[1]])
tmp.sd = as.numeric(tmp.data$error_factor*fossil.sd)

tmp.SI_results = simulated_inversion(alpha, tmp.W, tmp.sd, K, theta.test_vec,
                                 dating_error.mean=0, return_model = T)


tmp.SIRM_results.GB_start = estimate_CI.rm(
  W=tmp.W, K=K, alpha=alpha, max_iter=2000, eps.mean=dating_error.mean,
  eps.sigma=mean(tmp.sd), .CI_estimates=tmp.SI_results,
  .model=tmp.SI_results$model, return_iters = T, max_var=-1
)

tmp.SIRM_results.SIUGM_start = estimate_CI.rm(
  W=tmp.W, K=K, alpha=alpha, max_iter=2000, eps.mean=dating_error.mean,
  eps.sigma=mean(tmp.sd), .CI_estimates=tmp.SI_results,
  .model=tmp.SI_results$model, return_iters = T, max_var=-1,
  .starting_vals=c(tmp.SI_results$lower, tmp.SI_results$upper)
)

tmp.SIRM_results.bad_start = estimate_CI.rm(
  W=tmp.W, K=K, alpha=alpha, max_iter=2000, eps.mean=dating_error.mean,
  eps.sigma=mean(tmp.sd), .CI_estimates=tmp.SI_results,
  .model=tmp.SI_results$model, return_iters = T, max_var=-1,
  .starting_vals=c(14000, 5000)
)
```

```{r fig.height=10, fig.width=12}
# Combine all results tidily
tmp.results = rbind(
  # Garthwaite & Buckland Heuristic
  data.frame(`Starting Value` = "Percentile Method",
             Iteration = 1:length(tmp.SIRM_results.GB_start$lower.iters),
             Endpoint = "Lower Endpoint",
             Estimate = tmp.SIRM_results.GB_start$lower.iters),
  data.frame(`Starting Value` = "Percentile Method",
             Iteration = 1:length(tmp.SIRM_results.GB_start$upper.iters),
             Endpoint = "Upper Endpoint",
             Estimate = tmp.SIRM_results.GB_start$upper.iters),
  # SI-UGM Starting values
  data.frame(`Starting Value` = "SI-UGM",
             Iteration = 1:length(tmp.SIRM_results.SIUGM_start$lower.iters),
             Endpoint = "Lower Endpoint",
             Estimate = tmp.SIRM_results.SIUGM_start$lower.iters),
  data.frame(`Starting Value` = "SI-UGM",
             Iteration = 1:length(tmp.SIRM_results.SIUGM_start$upper.iters),
             Endpoint = "Upper Endpoint",
             Estimate = tmp.SIRM_results.SIUGM_start$upper.iters),
  # Manually selected starting values
  data.frame(`Starting Value` = "Manual",
             Iteration = 1:length(tmp.SIRM_results.bad_start$lower.iters),
             Endpoint = "Lower Endpoint",
             Estimate = tmp.SIRM_results.bad_start$lower.iters),
  data.frame(`Starting Value` = "Manual",
             Iteration = 1:length(tmp.SIRM_results.bad_start$upper.iters),
             Endpoint = "Upper Endpoint",
             Estimate = tmp.SIRM_results.bad_start$upper.iters)
)

SI_RM.starting_estimate_plot = tmp.results %>%
  filter(Iteration <= 1000) %>%
  filter(Starting.Value != "SI-UGM") %>%
  ggplot(aes(x=Iteration, y=Estimate, colour=Starting.Value)) +
  geom_line() +
  facet_wrap(Endpoint ~ ., scales="free", nrow=2) +
  theme(legend.title=element_blank())
SI_RM.starting_estimate_plot

ggsave(filename="../figures/SI-RM-starting-estimate-convergence.svg", plot=SI_RM.starting_estimate_plot)
```


$$
\eta = -\ln(K-\theta) \quad \theta = K - \exp(-\eta)
$$






















