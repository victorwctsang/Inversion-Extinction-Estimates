---
title: "Applications of MINMI and GBRM"
author: "Victor Tsang (z5209633)"
date: "`r Sys.Date()`"
output:
  pdf_document:
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load functions

```{r}
library(tidyverse)
library(readxl)

source("../src/garthwaite-robbins-munro-functions.R")
source("../src/minmi-functions.R")
source("../src/GRIWM.R")
source("../src/simulated-inversion.R")

theme_set(theme_bw())

alpha = 0.05
```

## Import Data

```{r}
cave_bear = read_excel(path='../data/fossildata.xlsx',
                     sheet="Ursus.spe.Eur.ext", 
                     range="M3:N33", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

mammoth = read_excel(path='../data/fossildata.xlsx',
                     sheet="Mammoths Eurasian", 
                     range="M3:N205", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

megaloceros = read_excel(path='../data/fossildata.xlsx',
                     sheet="Megaloceros", 
                     range="M3:N48", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

neanderthal = read_excel(path='../data/fossildata.xlsx',
                     sheet="NeandertalEur", 
                     range="M3:N147", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

bison = read_excel(path='../data/fossildata.xlsx',
                     sheet="BisPriscus.ext", 
                     range="M3:N15", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

jelephant = read_excel(path='../data/fossildata.xlsx',
                     sheet="Paleolox.Japan", 
                     range="M3:N13", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

cave_hyena = read_excel(path='../data/fossildata.xlsx',
                     sheet="CrocCroc.Eur", 
                     range="M3:N81", 
                     col_names=c("age", "sd"), 
                     col_types=c('numeric', 'numeric'))

tmp = rbind(data.frame(age=cave_bear$age, dataset="Cave Bear"),
            data.frame(age=bison$age, dataset="Steppe Bison"),
            data.frame(age=mammoth$age, dataset="Eurasian Mammoth"),
            data.frame(age=cave_hyena$age, dataset="Cave Hyena"))
```

## Histograms

```{r fig.height=3, fig.width=12}
p = tmp %>% ggplot(aes(x=age)) +
  geom_histogram(position="identity", color="black", fill="grey", bins=7) +
  facet_wrap(dataset ~ ., scale="free", nrow=1)

p
ggsave(file="../figures/applications-hists.svg", plot=p, width=12, height=3)
```

### SI-UGM Setup

```{r}
cave_bear.thetas = seq(22000, 29000)
mammoth.thetas = seq(4000, 14000)
megaloceros.thetas = seq(8000, 13000)
neanderthal.thetas = seq(38000, 44000)
bison.thetas = seq(25000, 35000)
jelephant.thetas = seq(25000, 35000)
cave_hyena.thetas = seq(20000, 30000)
```

## Driver Function

```{r}

estimate_extinction = function (data, theta.test_vec, alpha = 0.05, label) {
  K = max(data$age)
  data = data[data$age < K,]
  
  dates = data$age
  sd = data$sd
  
  # SI-UGM
  SIUGM.results = simulated_inversion(
    alpha = alpha,
    dates = dates,
    sd = sd,
    K = K,
    theta.test_vec = theta.test_vec,
    return_model = T
  )
  SIUGM = list(
    lower = SIUGM.results$lower,
    point = SIUGM.results$point,
    upper = SIUGM.results$upper,
    method = "SI-UGM"
  )
  
  # GRIWM - uncorrected
  griwm.uncorrected = GRIWM(
    df = data.frame(dates = dates, sd = sd),
    alpha = 0.05,
    K = K,
    p_t = 0.05,
    .n_iter = 10000,
    bias_adjusted = F
  )
  griwm.uncorrected.results = list(
    lower = griwm.uncorrected$lower_ci,
    point = griwm.uncorrected$centroid,
    upper = griwm.uncorrected$upper_ci,
    method = "GRIWM (q=0.05)"
  )
  
  # GRIWM - corrected
  griwm.corrected = GRIWM(
    df = data.frame(dates = dates, sd = sd),
    alpha = 0.05,
    K = K,
    p_t = 0.5,
    .n_iter = 10000,
    bias_adjusted = T
  )
  griwm.corrected.results = list(
    lower = griwm.corrected$lower_ci,
    point = griwm.corrected$centroid,
    upper = griwm.corrected$upper_ci,
    method = "GRIWM (q=0.5, bias adjusted)"
  )
  
  
  # MINMI
  MINMI = estimate_extinction.minmi(
    W = dates,
    sd = sd,
    level = 1 - alpha,
    K = K
  )
  MINMI$method = "MINMI"
  
  # SIRM
  SIRM = estimate_CI.rm(
    W = dates,
    K = K,
    alpha = alpha,
    max_iter = 3000,
    eps.mean = 0,
    eps.sigma = mean(sd),
    .model = SIUGM.results$model,
    .CI_estimates = list(lower = SIUGM.results$lower, upper = SIUGM.results$upper)
  )
  SIRM$method = "SI-RM"
  
  # Collate and return results
  estimates = data.frame(
    method = factor(),
    lower = numeric(),
    upper = numeric(),
    point = numeric(),
    n = numeric(),
    sigma = numeric(),
    dataset = factor()
  )
  estimates = rbind(estimates, MINMI, SIUGM, SIRM, griwm.uncorrected.results, griwm.corrected.results)
  estimates$n = length(dates)
  estimates$sigma = mean(sd)
  estimates$dataset = paste0(label, " (n=", length(dates), ")")
  return(estimates)
} 
```




## Estimations

```{r}

cave_bear.estimates = estimate_extinction(data = cave_bear, 
                                          theta.test_vec = cave_bear.thetas,
                                          label = "Cave Bear")

mammoth.estimates = estimate_extinction(data = mammoth, 
                                        theta.test_vec = mammoth.thetas,
                                        label = "Eurasian Mammoth")

# megaloceros.estimates = estimate_extinction(data = megaloceros,
#                                             theta.test_vec = megaloceros.thetas,
#                                             label="Giant Deer")


# neanderthal.estimates = estimate_extinction(data = neanderthal,
#                                             theta.test_vec = neanderthal.thetas,
#                                             label="Neanderthal")


bison.estimates = estimate_extinction(data=bison,
                                      theta.test_vec = bison.thetas,
                                      label="Steppe Bison")


# jelephant.estimates = estimate_extinction(data=jelephant,
#                                           theta.test_vec = jelephant.thetas,
#                                           label="Japanese Elephant")


cave_hyena.estimates = estimate_extinction(data=cave_hyena,
                                           theta.test_vec = cave_hyena.thetas,
                                           label="Cave Hyena")

all_results = rbind(cave_bear.estimates, mammoth.estimates, bison.estimates, cave_hyena.estimates)
```


## Combined


```{r fig.height=5, fig.width=8}
p = all_results %>%
  mutate(method_cat = ifelse(method == "MINMI", 2, ifelse(method == "SI-RM", 1, 0))) %>%
  ggplot(aes(colour=method)) +
  geom_pointrange(aes(y=reorder(method, method_cat), xmin=lower, xmax=upper, x=point)) +
  guides(colour="none") +
  labs(x="Years (BP)", y=NULL) +
  facet_wrap(fct_reorder(dataset, n) ~ ., ncol=2, dir='v', scale="free_x")
p
```

```{r}
ggsave(file="../figures/applications.svg", plot=p, height=5, width=8)
```


```{r}
library(knitr)

all_results %>%
  mutate(Extinction = paste0(scales::label_comma()(round(point, 1)), " (", scales::label_comma()(round(lower, 1)), " - ", scales::label_comma()(round(upper, 1)), ")"),
         Method = method) %>%
  select(Method, dataset, Extinction) %>%
  pivot_wider(names_from=dataset, values_from=Extinction) %>%
  kable(booktabs=T, format="latex") %>%
  writeLines("../figures/table-applications-CIs.tex")
```



